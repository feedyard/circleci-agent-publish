# src/commands/cve-scan.yaml

description: run snyk-cli:docker tests 

parameters:

  registry:
    description: Name of registry
    type: string
    default: docker.io

  image:
    description: Name of image
    type: string

  tag:
    description: Value for tag
    type: string
    default: dev.$CIRCLE_SHA1

  dockerfile:
    description: Name of dockerfile
    type: string
    default: Dockerfile

  snyk-token:
    description: snyk api-token
    type: env_var_name
    default: SNYK_TOKEN

  snyk-organization:
    description: Name of snyk organization
    type: string

steps:
  - run:
      name: snyk test --docker
      command: |
        docker run -it \
                   -e "SNYK_TOKEN=${<< parameters.snyk-token >>}" \
                   -e "PROJECT_FOLDER"="/project"
                   -v "${PWD}/project:/project" \
                   snyk/snyk-cli:1.320.0-docker test \
                   --org=<< parameters.snyk-organization >> \
                   --severity-threshold=low \
                   --docker << parameters.registry >>/<< parameters.image >>:<< parameters.tag >> \
                   --file=<< parameters.dockerfile >>
